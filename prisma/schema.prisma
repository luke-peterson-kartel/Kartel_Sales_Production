// Kartel Project Calculator - Database Schema
// https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// CORE ENTITIES
// ============================================

model Client {
  id            String    @id @default(cuid())
  name          String
  website       String?
  vertical      String    // Automotive, CPG, Fashion, Retail, Health, MediaTech, RealEstate, Entertainment
  notes         String?

  // Qualification
  qualified           Boolean   @default(false)
  qualificationScore  Int       @default(0)
  dealBehindSpec      Boolean   @default(false)

  // Red Flags (stored as JSON string)
  redFlags      String?   // JSON array: ["BUDGET_UNDER_600K", "ONE_OFF_ONLY", etc.]

  // Classification
  classification String   @default("UNDETERMINED") // SYSTEM, PROJECT, UNDETERMINED

  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  contacts      Contact[]
  projects      Project[]
  qualificationCalls QualificationCall[]
  conversations Conversation[]
  intelligence  ClientIntelligence?
}

model Contact {
  id        String   @id @default(cuid())
  name      String
  email     String?
  phone     String?
  role      String?  // Decision Maker, Stakeholder, Day-to-Day Contact
  isPrimary Boolean  @default(false)

  // Job Intelligence
  jobTitle          String?   // Exact title: "VP Marketing", "Creative Director"
  headline          String?   // LinkedIn headline
  department        String?   // MARKETING, CREATIVE, EXECUTIVE, PROCUREMENT, IT, OPERATIONS, FINANCE, SALES, OTHER
  seniority         String?   // C_LEVEL, VP, DIRECTOR, MANAGER, INDIVIDUAL_CONTRIBUTOR
  seniorityScore    Int?      // 1-10 scale for sorting (C_LEVEL=10, VP=8, DIRECTOR=6, MANAGER=4, IC=2)

  // Decision Authority
  decisionAuthority String?   // DECISION_MAKER, BUDGET_HOLDER, INFLUENCER, END_USER, GATEKEEPER
  buyingRole        String?   // CHAMPION, ECONOMIC_BUYER, TECHNICAL_BUYER, USER_BUYER, COACH

  // Social & Profile Links
  linkedInUrl       String?
  twitterUrl        String?
  githubUrl         String?
  facebookUrl       String?
  photoUrl          String?   // Profile photo URL

  // Location
  city              String?
  state             String?
  country           String?

  // Employment History (from Apollo)
  employmentHistory String?   // JSON: [{organization_name, title, start_date, end_date, current}]

  // Email Verification
  emailStatus       String?   // verified, guessed, unavailable, etc.

  // Enrichment Data
  enrichedAt        DateTime?
  enrichmentSource  String?   // WEBSITE_ANALYSIS, APOLLO, MANUAL, CONVERSATION
  enrichmentData    String?   // JSON: raw enrichment response for reference

  // Engagement Tracking
  lastContactedAt   DateTime?
  engagementScore   Int?      // Based on meeting attendance, email responses
  notes             String?   // Contact-specific notes

  clientId  String
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ClientIntelligence {
  id        String   @id @default(cuid())

  // Company Intelligence (extracted from website)
  companyDescription    String?   // What the company does
  companySize           String?   // STARTUP, SMB, MID_MARKET, ENTERPRISE
  estimatedEmployees    String?   // "50-100", "1000+"
  estimatedRevenue      String?   // Revenue range if known
  industry              String?   // More specific than vertical

  // Leadership/Team Data (extracted from website)
  leadershipTeam        String?   // JSON: [{name, title, linkedIn?, isLikelyDM?}]
  keyContacts           String?   // JSON: Potential contacts found on website

  // Marketing/Creative Intel
  currentCreativeApproach String? // What their current advertising/creative looks like
  brandGuidelines       String?   // Any brand info found
  socialPresence        String?   // JSON: {platforms: [], followers: {}}
  competitors           String?   // JSON: Known competitors

  // Talking Points (AI-generated suggestions)
  suggestedTalkingPoints String?  // JSON: Based on their creative approach
  suggestedQuestions    String?   // JSON: Discovery questions for this client

  // Analysis Metadata
  websiteAnalyzedAt     DateTime?
  websiteUrl            String?   // URL that was analyzed
  websiteContent        String?   // Cached relevant website text (truncated)
  analysisModel         String?   // Claude model used
  analysisTokens        Int?
  analysisError         String?   // Store any error message

  // Client Relationship (one-to-one)
  clientId  String   @unique
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Project {
  id              String    @id @default(cuid())
  jobId           String    @unique // Format: CLIENT-YYYYMMDD-###
  name            String

  // Type and Status
  type            String    // SPEC, STANDARD, ADVANCED
  status          String    @default("ON_DECK") // ON_DECK, IN_SPEC, IN_PRODUCTION, FINISHING, COMPLETE, CANCELLED
  currentPartition Int      @default(1) // 1-6 for physical folder position

  // Team Assignments (stored as JSON for flexibility)
  producer        String?
  creativeTeam    String?   // JSON array of names
  loraTeam        String?   // JSON array of names
  genTeam         String?   // JSON array of names
  externalArtists String?   // JSON array of names

  // Dates
  finalDueDate    DateTime?

  // Financials
  acv             Float?    // Annual Contract Value
  monthlyFee      Float?
  estimatedMargin Float?

  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  clientId        String
  client          Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)

  milestones      Milestone[]
  handoffs        Handoff[]
  estimates       Estimate[]
  deliverables    Deliverable[]
}

model Milestone {
  id            String    @id @default(cuid())
  name          String
  department    String    // Sales, Production, LoRA, GenEngineering
  order         Int       // For sorting

  // Status
  completed     Boolean   @default(false)
  completedAt   DateTime?
  completedBy   String?

  // Notes
  notes         String?

  projectId     String
  project       Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// ============================================
// QUALIFICATION & SALES
// ============================================

model QualificationCall {
  id          String    @id @default(cuid())
  callNumber  Int       // 1, 2, 3, or 4
  callType    String    // INTRO, PRODUCT_SCOPE, BUDGET_SCOPE, PROPOSAL

  // Status
  completed   Boolean   @default(false)
  completedAt DateTime?

  // Gate Criteria (stored as JSON)
  gateCriteria String?  // JSON object with checkbox states
  gateCleared  Boolean  @default(false)

  // Notes from call
  notes       String?

  // Discovery answers (for Call 2)
  discoveryAnswers String? // JSON object

  clientId    String
  client      Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)

  conversations Conversation[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// ============================================
// CONVERSATION PROCESSING
// ============================================

model Conversation {
  id              String    @id @default(cuid())

  // Raw Input
  rawTranscript   String    // Full pasted transcript text
  transcriptSource String   @default("manual") // manual, tactiq, otter, zoom, teams

  // Meeting Metadata (extracted by Claude)
  meetingDate     DateTime?
  meetingDuration String?   // e.g., "50 minutes"
  meetingStage    String?   // Discovery, Test Engagement, Proposal, etc.

  // Participants (stored as JSON)
  clientAttendees String?   // JSON array: [{name, role, notes, email}]
  kartelAttendees String?   // JSON array: [{name, role}]

  // Extracted Content (stored as JSON for flexibility)
  callSummary     String?   // JSON: {accountName, endClient, callType, keyTakeaways, concerns, nextSteps}
  opportunityData String?   // JSON: {accountInfo, contacts, opportunityDetails, openQuestions, dealSizing}
  testEngagement  String?   // JSON: {purpose, scope, deliverables, requirements, timeline, successCriteria, risks}
  followUpEmails  String?   // JSON array: [{emailType, to, cc, subject, body}]
  internalChecklist String? // JSON: {dataIntake: [], briefReview: [], communicationRhythm: []}

  // Processing Metadata
  processed       Boolean   @default(false)
  processedAt     DateTime?
  processingModel String?   // e.g., "claude-sonnet-4-20250514"
  processingTokens Int?     // For cost tracking
  processingError String?   // Store any error message

  // Client Relationship (optional - can be linked later)
  clientId        String?
  client          Client?   @relation(fields: [clientId], references: [id], onDelete: SetNull)

  // Link to qualification calls (many-to-many - a conversation can cover multiple stages)
  qualificationCalls QualificationCall[]

  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

// ============================================
// ESTIMATION
// ============================================

model Estimate {
  id              String    @id @default(cuid())
  name            String    @default("Draft Estimate")

  // Classification
  requiresLoRA           Boolean @default(false)
  requiresCustomWorkflow Boolean @default(false)
  projectType            String  @default("STANDARD") // STANDARD, ADVANCED

  // Calculated Outputs
  setupDays              Float   @default(0)
  monthlyGenTeamDays     Float   @default(0)
  monthlyProductionDays  Float   @default(0)
  monthlyQCDays          Float   @default(0)
  monthlyClientReviewDays Float  @default(0)

  // Totals
  totalMonthlyDays       Float   @default(0)
  totalAssets            Int     @default(0)

  // Contract Duration
  contractMonths         Int     @default(12)

  // Estimate's own deliverables (separate from project deliverables)
  deliverables  EstimateDeliverable[]

  projectId     String
  project       Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// Deliverables that belong to a specific Estimate
model EstimateDeliverable {
  id            String    @id @default(cuid())

  // Classification
  platform      String    // Meta, TikTok, Pinterest, YouTube, OLV, CTV, TV, GIF
  creativeType  String    // Static, Video, Carousel, UGC, Branded, IdeaPin, VideoPin
  size          String    // 1x1, 9x16, 4x5, 16x9, 2x3, 4x3
  duration      Int?      // In seconds: 6, 9, 15, 30, 45, 60 (null for static)

  // Volume
  monthlyCount  Int       @default(0)

  // Calculated effort (days per month)
  estimatedDays Float     @default(0)

  estimateId    String
  estimate      Estimate  @relation(fields: [estimateId], references: [id], onDelete: Cascade)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// Project's accepted/active deliverables (set when estimate is "applied")
model Deliverable {
  id          String    @id @default(cuid())

  // Classification
  platform    String    // Meta, TikTok, Pinterest, YouTube, OLV, CTV, TV, GIF
  creativeType String   // Static, Video, Carousel, UGC, Branded, IdeaPin, VideoPin
  size        String    // 1x1, 9x16, 4x5, 16x9, 2x3, 4x3
  duration    Int?      // In seconds: 6, 9, 15, 30, 45, 60 (null for static)

  // Volume
  monthlyCount Int      @default(0)
  totalCount   Int      @default(0)

  // Calculated effort (days per month)
  estimatedDays Float   @default(0)

  projectId   String
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// ============================================
// HANDOFFS
// ============================================

model Handoff {
  id            String    @id @default(cuid())
  handoffNumber Int       // 1, 2, 3, or 4
  type          String    // SALES_TO_PRODUCTION, PRODUCTION_TO_GENERATIVE, GENERATIVE_TO_PRODUCTION, PRODUCTION_TO_SALES

  // Status
  status        String    @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED
  completedAt   DateTime?

  // Timing compliance
  dueAt         DateTime?
  isOnTime      Boolean?

  // Checklist (stored as JSON)
  checklist     String?   // JSON object with checkbox states

  // Transferred content (stored as JSON)
  transferredItems String? // JSON array of items transferred

  // Notes
  notes         String?

  // Email export
  emailExported Boolean   @default(false)
  emailExportedAt DateTime?

  projectId     String
  project       Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// ============================================
// REFERENCE DATA
// ============================================

model Employee {
  id          String    @id @default(cuid())
  name        String
  email       String    @unique
  title       String
  department  String    // Sales, Production, Generative, Platform, Management, Community
  reportsTo   String?
  level       String    // executive, department_head, manager, Employee

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model CostTableTemplate {
  id              String    @id @default(cuid())
  name            String

  // Setup costs (in days)
  baseSetupDays         Float @default(7)   // Default setup for standard projects
  loraSetupDays         Float @default(21)  // Setup days when LoRA is required
  customWorkflowDays    Float @default(14)  // Setup days for custom workflow

  // Legacy setup costs (kept for reference)
  dataCaptureDays       Float @default(1)
  dataParsingDays       Float @default(1)
  dataCaptioningDays    Float @default(1)
  loraTrainingDays      Float @default(4)
  loraValidationDays    Float @default(2)
  workflowBuildDays     Float @default(2)
  imageGenerationDays   Float @default(5)
  videoGenerationDays   Float @default(5)
  totalSetupDays        Float @default(21)

  // Per-asset multipliers (days per asset type)
  staticImageDays       Float @default(0.1)   // Static images, carousels
  gifDays               Float @default(0.15)  // Animated GIFs
  shortVideoDays        Float @default(0.2)   // Videos 6-15 seconds
  mediumVideoDays       Float @default(0.3)   // Videos 16-30 seconds
  longVideoDays         Float @default(0.5)   // Videos 31-60 seconds

  // Team effort allocation (percentages as decimals, should sum to 1.0)
  genTeamPercent        Float @default(0.4)   // Gen team allocation (40%)
  productionPercent     Float @default(0.3)   // Production team allocation (30%)
  qcPercent             Float @default(0.2)   // QC team allocation (20%)
  clientReviewPercent   Float @default(0.1)   // Client review allocation (10%)

  isDefault             Boolean @default(false)

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}
